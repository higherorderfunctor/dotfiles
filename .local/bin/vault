#!/usr/bin/env bash

set -euETo pipefail
shopt -s inherit_errexit

# shellcheck source="../../Documents/dotfiles/src/_common"
. "$HOME/Documents/dotfiles/src/_common"

BW_ITEM_NAME="rclone - config"

declare -a NON_VAULT_COMMANDS=(
  config
  unlock
  rclone
)

if [ ! -v 1 ]; then
  print-error "COMMAND not specified\n"
elif [[ ! ${NON_VAULT_COMMANDS[*]} =~ $1 ]] && [[ ! -v 2 ]]; then
  print-error "VAULT not specified\n"
fi

if [[ "$1" == "unlock" ]]; then
  BW_STATUS="$(bw status | jq -r '.status')"
  if [[ -v BW_SESSION ]] && [[ "$BW_STATUS" == "unlocked" ]]; then
    print-info "Your vault is already unlocked\n"
    exit
  fi
  unset BW_SESSION
  if [[ "$BW_STATUS" == "unauthenticated" ]]; then
    SESSION="$(bw login)"
  elif [[ "$BW_STATUS" == "locked" ]]; then
    SESSION="$(bw unlock)"
  else
    print-error "Unknown vault status: '$BW_STATUS'"
  fi
  BW_SESSION=$(echo "$SESSION" | sed -nr 's/^\$ export BW_SESSION=(.*)$/\1/p')
  if [[ "$(bw status | jq -r '.status')" == "unlocked" ]]; then
    print-error "Failed to unlock your vault\n"
  fi
  print-info "Your vault is unlocked.  Use 'exit' to lock.\n"
  BW_SESSION=$BW_SESSION $SHELL
  BW_SESSION=$BW_SESSION bw lock
  exit
fi

if [[ ${NON_VAULT_COMMANDS[*]} =~ $1 ]] && [[ "$(bw status | jq -r '.status')" != "unlocked" ]]; then
  print-error "Your vault is not unlocked\n"
fi

# force sync bw once an hour
bw_last_sync="$(date -d "$(bw status | jq -r '.lastSync')" +%s)"
if [ "$bw_last_sync" -le "$(date -d "1 hour ago" +%s)" ]; then
  bw sync
fi

# test if remote rclone.conf is newer than local rclone.conf
if [[ ! -f "$HOME/.config/rclone/rclone.conf" ]] || [[ "$(date -d "$(bw get item "$BW_ITEM_NAME" | jq -r '.revisionDate')" +%s)" -gt "$(date -r "$HOME/.config/rclone/rclone.conf" "+%s")" ]] ; then
  # replace local rclone.conf with remote rclone.conf
  print-info "Updating local 'rclone.conf'\n"
  (
    set -x
    # backup local rclone.conf
    mv "$HOME/.config/rclone/rclone.conf" "$HOME/.config/rclone/rclone.local.conf.bk"
    # pull remote rclone.conf
    bw get attachment rclone.conf \
      --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')" \
      --output "$HOME/.config/rclone/rclone.conf"
    chmod 600 "$HOME/.config/rclone/rclone.conf"
    touch -d "$(date -Rd "$(bw get item "$BW_ITEM_NAME" | jq -r '.revisionDate')")" "$HOME/.config/rclone/rclone.conf"
  )
fi

RCLONE_PASSWORD_COMMAND="echo $(bw get password "$BW_ITEM_NAME")"
RCLONE_ARGS=(--transfers 32 --checkers 32)

export RCLONE_PASSWORD_COMMAND
export RCLONE_VERBOSE=1
# export RCLONE_STATS=5s

config() {
  rclone config "$@"
  # test if rclone.conf has been updated locally
  if [[ -f "$HOME/.config/rclone/rclone.conf" ]] && [[ "$(date -d "$(bw get item "$BW_ITEM_NAME" | jq -r '.revisionDate')" +%s)" -lt "$(date -r "$HOME/.config/rclone/rclone.conf" "+%s")" ]] ; then
    {
      set -x
      # backup remote rclone.conf locally
      bw get attachment rclone.conf \
        --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')" \
        --output "$HOME/.config/rclone/rclone.remote.conf.bk"
      chmod 600 "$HOME/.config/rclone/rclone.remote.conf.bk"
      # only update if local is different than remote
      if ! cmp --silent "$HOME/.config/rclone/rclone.conf" "$HOME/.config/rclone/rclone.remote.conf.bk"; then
        print-info "Updating remote 'rclone.conf'\n"
        # delete old backup remote rclone.conf
        if [[ -n "$(bw get item 'rclone - config' | jq -r 'first(.attachments | .[] | select(.fileName=="rclone.remote.conf.bk")) | .id')" ]]; then
          bw delete attachment \
          "$(bw get item 'rclone - config' | jq -r 'first(.attachments | .[] | select(.fileName=="rclone.remote.conf.bk")) | .id')" \
          --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')"
        fi
        # push new backup remote rclone.conf
        bw create attachment \
          --file "$HOME/.config/rclone/rclone.remote.conf.bk" \
          --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')"

        # delete remote rclone.conf
        bw delete attachment \
          "$(bw get item 'rclone - config' | jq -r 'first(.attachments | .[] | select(.fileName=="rclone.conf")) | .id')" \
          --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')"
        # push rclone.conf
        bw create attachment \
          --file "$HOME/.config/rclone/rclone.conf" \
          --itemid "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')"

        # force sync local and remote timestamps
        bw get item \
          "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')" |
          bw encode |
          bw edit item "$(bw get item "$BW_ITEM_NAME" | jq -r '.id')"
        touch -d "$(date -Rd "$(bw get item "$BW_ITEM_NAME" | jq -r '.revisionDate')")" "$HOME/.config/rclone/rclone.conf"

        # sync
        bw sync
      else
        print-info "\nNo changes to 'rclone.conf'\n"
      fi
    }
  else
    print-info "\nNo changes to 'rclone.conf'\n"
  fi
}

mount-local () {
  mkdir -p "$HOME/.local/share/rclone/mnt/${1^}"
  rclone mount \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    --daemon \
    --progress \
    --vfs-cache-mode full \
    "crypt-$1:" "$HOME/.local/share/rclone/mnt/${1^}"
  if [[ -d "$HOME/.local/share/rclone/mnt/${1^}/.Trash-$UID" ]]; then
    rm -r "$HOME/.local/share/rclone/mnt/${1^}/.Trash-$UID"
  elif [[ ! -f "$HOME/.local/share/rclone/mnt/${1^}/.Trash-$UID" ]]; then
    touch "$HOME/.local/share/rclone/mnt/${1^}/.Trash-$UID"
  fi
  xdg-open "$HOME/.local/share/rclone/mnt/${1^}"
}

mount-remote () {
  mkdir -p "$HOME/.local/share/rclone/mnt/${1^} (remote)"
  rclone mount \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    --daemon \
    --progress \
    --vfs-cache-mode full \
    "crypt-remote-$1:" "$HOME/.local/share/rclone/mnt/${1^} (remote)"
  if [[ -d "$HOME/.local/share/rclone/mnt/${1^} (remote)/.Trash-$UID" ]]; then
    rm -r "$HOME/.local/share/rclone/mnt/${1^} (remote)/.Trash-$UID"
  elif [[ ! -f "$HOME/.local/share/rclone/mnt/${1^} (remote)/.Trash-$UID" ]]; then
    touch "$HOME/.local/share/rclone/mnt/${1^} (remote)/.Trash-$UID"
  fi
  xdg-open "$HOME/.local/share/rclone/mnt/${1^} (remote)"
}

unmount-local() {
  fusermount -u "$HOME/.local/share/rclone/mnt/${1^}"
}

unmount-remote() {
  fusermount -u "$HOME/.local/share/rclone/mnt/${1^} (remote)"
}

force-unmount-local() {
  fusermount -uz "$HOME/.local/share/rclone/mnt/${1^}"
}

force-unmount-remote() {
  fusermount -uz "$HOME/.local/share/rclone/mnt/${1^} (remote)"
}

check() {
  RCLONE_VERBOSE=0 rclone cryptcheck \
    "${@:2}" \
    "${RCLONE_ARGS[@]}" \
    --combined -u --progress \
    "crypt-$1:" "crypt-remote-$1:"
}

sync-remote() {
  rclone sync \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    -u --progress \
    "crypt-$1:" "crypt-remote-$1:"
}

sync-local() {
  rclone sync \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    -u --progress \
    "crypt-remote-$1:" "crypt-$1:"
}

push() {
  rclone copy \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    -u --progress \
    "crypt-$1:" "crypt-remote-$1:"
}

pull() {
  rclone copy \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    -u --progress \
    "crypt-remote-$1:" "crypt-$1:"
}

show-hidden() {
  vault rclone ls \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    --b2-versions -q \
    "crypt-remote-$1:" |
    { grep --color -B1 -P 'v\d{4}-\d{2}-\d{2}-\d{6}-\d{3}(\.[.]*)?' || true; }
}

cleanup() {
  rclone cleanup \
    "${RCLONE_ARGS[@]}" \
    "${@:2}" \
    --progress \
    "crypt-remote-$1:"
}

case $1 in
  config) config "${@:2}";;
  mount-local) mount-local "${@:2}";;
  mount-remote) mount-remote "${@:2}";;
  unmount-local) unmount-local "${@:2}";;
  unmount-remote) unmount-remote "${@:2}";;
  force-unmount-local) force-unmount-local "${@:2}";;
  force-unmount-remote) force-unmount-remote "${@:2}";;
  check) check "${@:2}";;
  sync-remote) sync-remote "${@:2}";;
  sync-local) sync-local "${@:2}";;
  push) push "${@:2}";;
  pull) pull "${@:2}";;
  show-hidden) show-hidden "${@:2}";;
  cleanup) cleanup "${@:2}";;
  rclone) RCLONE_VERBOSE=0 rclone "$2" "${RCLONE_ARGS[@]}" "${@:3}";;
  *) print-error "Unknown COMMAND: '$1'\n";;
esac
